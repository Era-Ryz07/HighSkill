<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Donasi</title>

  <link rel="stylesheet" href="donasi.css">
  <link rel="stylesheet" href="sidebar.css">
</head>

<body data-title="Donasi" data-section="donasi">

<!-- SIDEBAR (load otomatis) -->
<div id="sidebar-container"></div>

<nav class="toggle-don">
  <a href="donasi-irl.html" class="on">Duit Sumbangan</a>
</nav>
<!-- MAIN -->
<div class="content-wrap">
  <div class="main-area">
    <div class="container page-header">
      <h1>Leaderboard Sumbangan</h1>
      <p class="hint">Sumbangan akan digunakan untuk biaya Guild dan mungkin untuk hadiah</p>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <button onclick="window.open('https://sociabuzz.com/ryzhighskill07/tribe', '_blank')" class="form">Click>donasi</button>

<style>
*{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family:'Poppins', sans-serif;
  background:#fff;
  overflow-x:hidden;
}

.form {
  border: none;
  background-color: black;
  color: white;
  padding: 8px 5px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  min-width: 167px;
  font-size: 16px;
  padding-left :120px;
  padding-right :115px;
}

/* TOTAL */
.total-box{
  width:92%;
  max-width:500px;
  margin:15px auto;
  padding:15px;
  background:#e9e9e2;
  border:2px solid #888;
  border-radius:18px;
  text-align:center;
}

.total-box h2{
  margin:0;
  font-size:18px;
  font-weight :600;
  color :#555;
}

.total-box h1{
  margin:6px 0 0;
  font-size:26px;
  color:#1f8f2e;
}

/* SEARCH */
.search-box{
  width:92%;
  max-width:500px;
  margin:15px auto;
}

.search-box input{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:2px solid black;
  font-size:14px;
}

/* CARD */
.card{
  width:92%;
  max-width:500px;
  margin:15px auto;
  background:#fff;
  border:2px solid black;
  border-radius:20px;
  padding:15px;
  display:flex;
  align-items:center;
  gap:15px;
}

.rank{
  font-size:50px;
  font-weight:700;
  color:black;
  width:45px;
}

.name{
  font-size:20px;
  font-weight:600;
  border-bottom:1px solid #c8c1a5;
  padding-bottom:4px;
}

.amount{
  font-size:19px;
  font-weight:700;
  color:#1f8f2e;
}

</style>
</head>
<body>

<div class="total-box">
  <h2>Total Semua Sumbangan</h2>
  <h1 id="total">Rp 0</h1>
</div>

<div class="search-box">
  <input type="text" id="search" placeholder="Cari Nama...">
</div>

<div id="list"></div>

<script>

// ==========================
// DATA (EDIT DI SINI)
// ==========================
const data = [
  {name:"belum ada", amount:0},
];

// ==========================
// RENDER LIST
// ==========================
function renderList(filter=""){
  const list = document.getElementById("list");
  list.innerHTML = "";

  let total = 0;

  const filtered = data.filter(item =>
    item.name.toLowerCase().includes(filter.toLowerCase())
  );

  filtered
  .sort((a,b)=> b.amount - a.amount)
  .forEach((item,index)=>{
    total += item.amount;

    list.innerHTML += `
      <div class="card">
        <div class="rank">${index+1}</div>
        <div>
          <div class="name">${item.name}</div>
          <div class="amount">Rp ${item.amount.toLocaleString("id-ID")}</div>
        </div>
      </div>
    `;
  });

  document.getElementById("total").innerText =
    "Rp " + total.toLocaleString("id-ID");
}

// ==========================
// SEARCH EVENT
// ==========================
document.getElementById("search").addEventListener("input", function(){
  renderList(this.value);
});

// LOAD AWAL
renderList();

</script>

<script>
/* =======================================
   LOAD SIDEBAR
======================================= */
fetch('sidebar.html')
  .then(res => res.text())
  .then(html => {
    document.getElementById('sidebar-container').innerHTML = html;

    const sidebar = document.querySelector(".sidebar");
    const menuBtn = document.getElementById("menuBtn");

    /* ==========================
       UPDATE JUDUL HEADER
    ========================== */
    const pageTitle = document.getElementById("pageTitle");
    if (pageTitle) {
      pageTitle.textContent = document.body.dataset.title || "No Title";
    }

    /* ==========================
       TOGGLE SIDEBAR
    ========================== */
    menuBtn.addEventListener("click", e => {
      e.stopPropagation();
      sidebar.classList.toggle("active");
      menuBtn.classList.toggle("active");
    });

    document.addEventListener("click", e => {
      if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
        sidebar.classList.remove("active");
        menuBtn.classList.remove("active");
      }
    });

    /* ==========================
       ACTIVE MENU (BY SECTION)
    ========================== */
    const section = document.body.dataset.section;

    document.querySelectorAll(".sidebar a").forEach(a => {
      const href = a.getAttribute("href").toLowerCase();
      a.classList.remove("active");

      if (section === "donasi" && href.includes("donasi")) {
        a.classList.add("active");
      }
      if (section === "game" && href.includes("game")) {
        a.classList.add("active");
      }
    });

  });


/* =======================================
   GOOGLE SHEET
======================================= */
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/1T_t_Hu8DUMvPNAVc-ExMEIHjInLf-xxrXHRdXlz71z0/gviz/tq?gid=630977817&tqx=out:json";


function parseGviz(text){
  const jsonText = text.replace(/^[^\{]*/, '').replace(/\);?$/, '');
  return JSON.parse(jsonText);
}
function tableToObjects(table){
  const cols = table.cols.map(c => (c.label || c.id).trim());
  return table.rows.map(r=>{
    const o={}; r.c.forEach((cell,i)=>{ o[cols[i]] = cell?cell.v:""; }); return o;
  });
}
function detectFields(cols){
  const lower = cols.map(c => c.toLowerCase());
  let nameKey=null, jumlahKey=null;
  for(let i=0;i<lower.length;i++){
    if(!nameKey && lower[i].includes("nama")) nameKey = cols[i];
    if(!jumlahKey && lower[i].includes("jumlah")) jumlahKey = cols[i];
  }
  return { nameKey, jumlahKey };
}
function parseNumber(v){
  if(typeof v === "number") return v;
  let s = String(v).replace(/\./g,"").replace(/,/g,"").replace(/[^\d-]/g,"");
  return parseFloat(s) || 0;
}
function escapeHtml(s){
  return s.replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}
function formatRupiah(n){
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}


/* =======================================
   RENDER LIST
======================================= */
function renderCards(data){
  const result=document.getElementById("result");
  if(!data.length){
    result.innerHTML = `<div class="loading">Belum ada data.</div>`;
    return;
  }

  const filter = (document.getElementById("filterName").value || "").toLowerCase();
  const filtered = filter ? data.filter(d => d.name.toLowerCase().includes(filter)) : data;

  let html = `<div class="leaderboard-list">`;
  filtered.forEach((d,i)=>{
    html += `
      <div class="donation-item">
        <div class="rank-big">${i+1}</div>
        <div class="info-right">
          <div class="donor-name">${escapeHtml(d.name)}</div>
          <div class="donor-total">Rp ${formatRupiah(d.total)}</div>
        </div>
      </div>`;
  });
  html += `</div>`;

  result.innerHTML = html;
}


/* =======================================
   LOAD DATA
======================================= */
async function loadData(){
  const result=document.getElementById("result");
  result.innerHTML = `<div class="loading">Memuat data...</div>`;

  try{
    const txt = await (await fetch(SHEET_URL,{cache:"no-store"})).text();
    const json = parseGviz(txt);
    const rows = tableToObjects(json.table);

    const cols = json.table.cols.map(c => c.label || c.id || "");
    const { nameKey, jumlahKey } = detectFields(cols);

    if(!nameKey || !jumlahKey){
      result.innerHTML = `<div class="error">Kolom nama/jumlah tidak ditemukan.</div>`;
      return;
    }

    const map = new Map();
    let totalSemua = 0;

    rows.forEach(r=>{
      const name = String(r[nameKey] || "").trim();
      if(!name) return;

      const jumlah = parseNumber(r[jumlahKey]);
      totalSemua += jumlah;

      const key = name.toLowerCase();
      if(!map.has(key)) map.set(key,{ name, total:0 });
      map.get(key).total += jumlah;
    });

    document.getElementById("grandTotal").textContent =
      "Rp " + formatRupiah(totalSemua);

    const arr = Array.from(map.values()).sort((a,b)=>b.total-a.total);
    renderCards(arr);

  } catch(err){
    result.innerHTML = `<div class="error">Gagal memuat data.</div>`;
    console.error(err);
  }
}


/* =======================================
   EVENT HANDLER
======================================= */
document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("refreshBtn").onclick = ()=> loadData();
  document.getElementById("filterName").oninput = ()=> setTimeout(loadData,150);

  loadData();
  setInterval(loadData, 120000);
});
</script>

</body>
</html>